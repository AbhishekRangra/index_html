pipeline {
    agent any

    environment {
        VALUES_YAML = 'mychart/values.yaml'
    }

    stages {
        stage('Extract Tag') {
            steps {
                script {
                    def yaml = readFile(VALUES_YAML)
                    def tagLine = yaml.readLines().find { it.trim().startsWith('tag:') }
                    def tag = tagLine.split(':')[1].trim().replaceAll('"', '')
                    env.IMAGE_TAG = tag
                    echo "Deploying using image tag: ${env.IMAGE_TAG}"
                }
            }
        }

        stage('Deploy Helm Chart') {
            steps {
                sh """
                    helm upgrade --install my-release ./mychart --values ${VALUES_YAML}
                """
            }
        }
    }
}
